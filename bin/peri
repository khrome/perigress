#!/usr/bin/env node
const CLApp = require('app-term-kit');
const express = require('express');
const path = require('path');
const bodyParser = require('body-parser');
const Perigress = require('../perigress');


let app = new CLApp('perigress', {
    copyright : 'Abbey Hawk Sparrow',
    copystart : '2022',
    defaults : `{
  // This file was autogenerated by perigress
  //
  "debug": false
}`
});

app.command({
    name : 'serve',
    description: 'Run a server from a definition',
    examples : [
        [
            '$0 xpath "//table/tbody/tr" dump.html',
            'select all table rows in the file `dump.html`'
        ]
    ],
    action : function(argv, target, complete){
        const port = argv.port || 8080;
        const expressInstanceFetcher = argv.express?require(path.join(process.cwd(), argv.express)):()=>{
          const app = express();
          app.use(bodyParser.json({strict: false}))
          return app;
        }
        const app = expressInstanceFetcher();
        const api = new Perigress.DummyAPI({
            subpath : target,
            dir: process.cwd()
        });
        api.ready.then(()=>{
            api.attach(app);
            const server = app.listen(port, ()=>{
                console.log('Perigress Server running on '+port);
            });
        });
    }
});

app.command({
    name : 'generate-tables',
    description: 'Synthetic tables from a definition',
    examples : [],
    action : function(argv, target, complete){
        let path = argv.api || target || path.join(__dirname, '../../..')
        let perigress = new Perigress.DummyAPI(path);
        let format = 'sql';
        if(argv.sequelize) format = 'sequelize';
        perigress.generateDataDefinitions({
            format,
            sequelizePath: argv.sequelize,
            seperate: argv.seperate,
            isForeignKey: (type, name, value)=>{
                let engine = perigress.endpoints.find((endpoint)=>{
                    return endpoint.options.name === type;
                });
                if(!engine) return false;
                return engine.options.expandable(type, name, value)
            }
        }, (err, result)=>{
            console.log(result);
            complete();
        });
        //
    }
});

app.command({
    name : 'generate-migration',
    description: 'Synthetic tables from a definition',
    examples : [],
    action : function(argv, target, complete){
        let path = argv.api || target || path.join(__dirname, '../../..');
        let destination = argv._.shift();
        let incoming = (argv._.shift() || 'ups').trim();
        let type = null;
        if(incoming === 'up') type = 'ups';
        if(incoming === 'down') type = 'downs';
        let perigress1 = new Perigress.DummyAPI(path);
        let perigress2 = new Perigress.DummyAPI(destination);
        let format = 'sql';
        if(argv.sequelize) format = 'sequelize';
        if(argv.mongo) format = 'mongo';
        perigress1.generateMigrations(perigress2, {
            format,
            sequelizePath: argv.sequelize,
            seperate: argv.seperate
        }, (err, result)=>{
            if(typeof result === 'string'){
                console.log(result);
            }else{
                console.log((result[(type || 'ups')]||[]).join(";\n"));
            }
            complete();
        });
        //
    }
});

app.command({
    name : 'generate-data',
    description: 'Synthetic tables from a definition',
    examples : [],
    action : function(argv, target, complete){
        let path = argv.api || target || path.join(__dirname, '../../..')
        let incoming = (argv._.shift()).trim();
        let id = (argv._.shift() || '').trim();
        let perigress = new Perigress.DummyAPI(path);
        let format = 'sql';
        if(argv.sequelize) format = 'sequelize';
        if(argv.mongo) format = 'mongo';
        perigress.ready.then(()=>{
            let e = perigress.endpoints.find((e)=> e.options.name === incoming);
            if(e){
                let num = (id || Math.random()+'');
                e.generate(num, {
                    format
                }, (err, result)=>{
                    let finalResult = e.formatItems({format}, result);
                    console.log(finalResult);
                    complete();
                });
            }else{
                console.log('could not find endpoint: '+incoming);
            }
        });
    }
});

app.argument('api', 'string', 'Path to the directory defining the API', 1);
app.argument('sequelize', 'string', 'Output sequelize scripts for data definitions', 1);
app.argument('port', 'number', 'port to run the server on', 1);
app.argument('sql', 'boolean', 'Output raw SQL for data definitions', 0);
app.argument('seperate', 'boolean', 'Spit data model into multiple files', 0);
app.argument('express', 'string', 'express instance to use', 0);

app.header();
app.footer();
app.help();
app.run((err)=>{
    if(err) console.log(err);
});
